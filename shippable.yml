language: node_js

node_js:
  - 10.15.1

env:
  global:
    # The path for Xunit to output test reports
    - XUNIT_FILE=shippable/testresults/result.xml
    - LC_ALL=C
    # UNITO_NPM_REGISTRY_TOKEN
    - secure: oqKSChZedLtAtJgDDbKZWyPdsCH+2VbGIQJYV76FTB2yWlR0oUau+L6ZjiQawXE3eNFN0ji+5I0hUJnJdhzbbxZCJlRXBPDBcMOJXcgMZppFsVpZOPL+yGwLQJ/RjnWdeTIBbnqd334spnxCt63b/yJ2rrwylR16dnDmNpm+OvDUXzPXls/s1cWP5tV5cpXuzK74+MazeabvLzUTFpMXSVQT4a5mpR5uUrZXdyNe+zww1B9In63Uz1cX+EgQlcyCOn0RLDtntIVnk1V8GcAaY0h0GCOAcvpEpHz11aTpvUtQ0VOqgb3khJmeM8YJO4J/0bzJykrvmGCAEBKE79lIqw==
      
branches:
  only:
    - master

build:
  pre_ci_boot:
    image_name: 418344807563.dkr.ecr.us-east-1.amazonaws.com/shippable-docker-images
    image_tag: latest
    pull: true
    options: "-e HOME=/root" 
  ci:
    - shippable_retry npm ci
    - npm run audit-with-ignore
    - npm run lint
    - npm run test:ci
  on_success:
    - git remote set-url origin $REPOSITORY_URL
    - git config --get remote.origin.url
    - npm config set '//registry.npmjs.org/:_authToken' "${UNITO_NPM_REGISTRY_TOKEN}"
    - bash bump_node_package_version.sh
    - bash publish_node_package.sh

integrations:
  notifications:
    - integrationName: email
      type: email
      recipients:
        - dev@unito.io
      on_failure: always
      on_success: never
      on_pull_request: never
      on_start: never
  hub:
    - integrationName: shippable-docker-images
      type: ecr
      region: us-east-1

